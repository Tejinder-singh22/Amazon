const productModel = require("../model/productModel");
const { findOneAndUpdate } = require("../model/userModel");
const ApiFeatures = require("../utils/ApiFeatures");




const addProduct = async (req,res,next)=>{
    console.log(" her in controller")

    req.body.user = req.user.id;   // add userid in body 

      const product = await productModel.create(req.body);
 
      res.status(200).json({
        success:true,
        product
      })
}

const getAllProducts = async (req,res,next)=>{
      
     var resultPerPage = 5;
      console.log(req.query);
     const obj = new ApiFeatures(productModel.find(),req.query).pagination(resultPerPage);

     console.log(obj.query+ "final query");

     const products = await obj.query;

     res.status(200).json({
        success: true,
        products
     })
}

const addDiscount = async (req, res)=>{
console.log("i am adding discount");
   const reqBody = {...req.body};
   const category = reqBody.category;
   const discount = reqBody.discount;
   console.log(discount);

   const productsCategorised = await productModel.find({category: category});

  //  console.log(JSON.stringify(productsCategorised))
if(discount && discount !== 0){
   productsCategorised.forEach(async (e)=>{
          const newPrice = e.price / 100 * discount;
          console.log(newPrice);
           await productModel.findOneAndUpdate({_id: e._id},{$set : {price: newPrice, discount : discount, updatedAt: Date.now()}});
   })
}
   console.log("");
   res.status(200).json({
    success: true,
    productsCategorised
 })
}


const removeDiscount = async (req, res)=>{
   console.log("removing discount");
   const reqBody = {...req.body};
   const category = reqBody.category;


   console.log("removing discount everytime");
   const productsCategorised = await productModel.find({category: category});
   console.log(category);
   productsCategorised.forEach(async (e)=>{
      // if discount == 0
      console.log(e.original_price + "original price");
      
         await productModel.findOneAndUpdate({_id: e._id},{$set : {price: e.original_price, discount : 0, updatedAt: Date.now()}});
  })

  res.status(200).json({
   success: true,
   productsCategorised
})
 
}
module.exports = {addProduct, getAllProducts,addDiscount,removeDiscount }